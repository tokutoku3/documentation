{{ define "api-main" }}

    {{ with .Content}}
        <div class="col-12 col-lg-9">
            {{ . }}
        </div>
    {{ end }}

    {{ $dot := . }}

    {{ .Scratch.Set "apiVersion" "v1"}}

    {{ if in .Permalink "api/v2" }}
        {{ .Scratch.Set "apiVersion" "v2"}}
    {{ end }}

    {{ $apiVersion := .Scratch.Get "apiVersion"}}

    {{ $.Scratch.Set "ParamTitleEn" ($.Params.title) }}
    {{ if $dot.IsTranslated }}
      {{ range $dot.Translations }}
        {{ if eq .Lang "en" }}
            {{ $.Scratch.Set "ParamTitleEn" (.Params.title) }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ $ParamTitleEn := ($.Scratch.Get "ParamTitleEn") }}

    {{ $d := index $dot.Site.Data.api.v1 "full_spec_deref" }}
    {{ $d2 := index $dot.Site.Data.api.v2 "full_spec_deref" }}

    <!-- get lang specific data file -->
    {{ $tagSlug := path.Base .File.Dir }}
    {{ $.Scratch.Set "translate_tags" (dict) }}
    {{ $.Scratch.Set "translate_actions" (dict) }}
    {{ if ne $.Page.Lang "en"}}
        {{ if (fileExists (print "data/api/" $apiVersion "/translate_tags." $.Page.Lang ".json")) }}
          {{ $.Scratch.Set "translate_tags" (index (index $.Site.Data.api $apiVersion) (print "translate_tags." $.Page.Lang)) }}
        {{ end }}
        {{ if (fileExists (print "data/api/" $apiVersion "/translate_actions." $.Page.Lang ".json")) }}
          {{ $.Scratch.Set "translate_actions" (index (index $.Site.Data.api $apiVersion) (print "translate_actions." $.Page.Lang)) }}
        {{ end }}
    {{ end }}
    {{ $translate_tags := ($.Scratch.Get "translate_tags") }}
    {{ $translate_actions := ($.Scratch.Get "translate_actions") }}

<!-- if no api menu in other languages fallback to english -->
{{ with index .Site.Menus "api" }}
  {{ $dot.Scratch.Set "menu" . }}
{{ else }}
  {{ $dot.Scratch.Set "menu" (index .Sites.First.Menus "api") }}
{{ end }}
{{ $menu := .Scratch.Get "menu" }}

<!-- get this translate tag -->
{{ $translate_tag := (index $translate_tags $tagSlug) | default (dict) }}

<!-- lets show the intro text, shall we use v1 or v2 text. Lets try v1 for now.. -->
{{ partial "api/intro.html" (dict "tags" $dot.Site.Data.api.v1.full_spec_deref.tags "title" $dot.Params.title "translate_tag" $translate_tag) }}

<!-- Loop over the menu to determine what to pull in -->
{{ range (where .Sites.First.Menus.api ".Name" "==" .Params.title) }}
  {{ range $menuChild := .Children }}

    <!-- If we have multiple endpoints for a version output them next to each other -->
    {{ $versionCount := len .Params.versions }}
    {{ range $versionIndex, $versionNum := .Params.versions }}
      {{ $adat := (index (index $dot.Site.Data.api $versionNum) "full_spec_deref") }}

      <!-- Get the general API server url for this version -->
      {{ $generalRegions := partial "api/regions.html" (dict "servers" $adat.servers) }}

      <!-- for accessing v1/v2 resources from latest -->
      {{ $resourcePage := $dot.Site.GetPage (print "/api/" $versionNum "/" (path.Base $dot.File.Dir) "/_index.md") }}

      {{ range $tag := (where $adat.tags ".name" "==" $dot.Params.title) }}

        {{ $endpoint := partial "api/get-endpoint.html" (dict "lang" $.Page.Lang "operationids" $menuChild.Params.operationids "spec" $adat "generalRegions" $generalRegions ) }}
        {{ $isVisibleVersion := (and (gt $versionCount 1) (eq $versionIndex 0)) }}
        {{ $isCollapsedVersion := (and (gt $versionCount 1) (eq $versionIndex 1)) }}

        <!-- get action strings from params, why? because they are translated here -->
        {{ $translate_action := (index $translate_actions $endpoint.action.operationId) | default (dict) }}

        <!-- endpoint section start -->
        {{ if $endpoint }}
        <div class="row endpoint {{ if $isCollapsedVersion }}isCollapsed{{ end }}">
            <div class="col-12 col-lg-9">
                {{ $anchorStr := ($translate_action.summary | default $endpoint.action.summary) }}
                {{ if $isCollapsedVersion }}
                  {{ $anchorStr = print ($translate_action.summary | default $endpoint.action.summary) " " $versionNum }}
                {{ end }}
                <h2 class="mb-2" id="{{ $anchorStr | anchorize }}">
                    {{ if $isCollapsedVersion }}<span class="toggle-arrow"><svg width="18" height="27" viewBox="0 0 6 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.7294 4.45711L0.733399 7.82311L1.1294 8.29111L5.6654 4.45711L1.1294 0.641113L0.751398 1.12711L4.7294 4.45711Z" fill="black"></path></svg></span>&nbsp;{{ end }}
                    <a class="js-collapse-trigger" href="#{{ $anchorStr | anchorize }}">
                      {{- $anchorStr -}}
                    </a>
                </h2>
                <div class="endpoint-content {{ if $isCollapsedVersion }}d-none{{ end }}">

                    <!-- Unstable Notification -->
                    {{ with index $endpoint.action "x-unstable"}}
                      <div class="alert alert-warning mb-2">
                          <p class="alert-warning">{{ . | markdownify }}</p>
                      </div>
                    {{ end }}

                    <!-- Multiple versions notification -->
                    {{ if $isVisibleVersion }}
                      {{ $collapsedAnchorStr := (print $endpoint.action.summary " " (replace $versionNum "1" "2")) }}
                      <div class="alert alert-warning mb-2">
                        <p class="alert-warning">Note: For the v2 version of this endpoint, which is in public beta, see <a href="#{{ $collapsedAnchorStr | anchorize }}">{{- $collapsedAnchorStr -}}.</a></p>
                      </div>
                    {{ end }}

                    <p class="mb-0"><span style="padding: 3px" class="font-semibold text-api-{{ $endpoint.actionType }} bg-bg-api-{{ $endpoint.actionType }}">{{ $endpoint.actionType | upper }}</span>&nbsp;
                      {{- range $region, $url := $endpoint.regions -}}
                          <span class="d-none" data-region="{{ $region }}">{{ $url }}{{ $endpoint.pathKey }}</span>
                      {{- end -}}
                      {{- range $region, $url := $generalRegions -}}
                          {{- if not (index ($endpoint.regions) $region) -}}
                              <span class="d-none" data-region="{{ $region }}">Not supported in the {{ upper $region }} region</span>
                          {{- end -}}
                      {{- end -}}
                    </p>

                    <h3 class="mt-2">{{ i18n "overview" }}</h3>
                    <p>{{ $endpoint.action.description | markdownify }}</p>

                    <!-- querystring, path params, header params -->
                    {{ partial "api/arguments.html" (dict "parameters" $endpoint.action.parameters) }}

                    <!-- request body -->
                    {{ partial "api/request-body.html" (dict "body" $endpoint.action.requestBody "resourcePage" $resourcePage "operationid" $endpoint.action.operationId "translate_action" $translate_action) }}

                    <!-- response -->
                    {{ partial "api/response.html" (dict "responses" $endpoint.action.responses "resourcePage" $resourcePage "operationid" $endpoint.action.operationId "translate_action" $translate_action) }}

                    <!-- code example -->
                    {{/* {{ partial "api/code-example.html" (dict "context" $dot "resourcePage" $resourcePage "operationid" $endpoint.action.operationId "securitySchemes" $adat.components.securitySchemes ) }} */}}
                </div>
            </div>
        </div>
        {{ end }}
        <!-- endpoint section end -->

      {{ end }}
    {{ end }}

    <div class="row divider">
        <div class="col-12">
            <hr class="mt-0 mb-2" style="border-top: 2px solid#DADADA"/>
        </div>
    </div>

  {{ end }}
{{ end }}

{{ end }}
